/************************************************************************/
/* システム名   : RD8001快眠チェッカー									*/
/* ファイル名   : calc_pulseoximeter.c									*/
/* 機能         : パルスオキシメーター演算処理							*/
/* 変更履歴     : 2018.01.11 Axia Soft Design 和田 初版作成				*/
/* 注意事項     : なし													*/
/************************************************************************/
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "calc_pulseoximeter.h"
#include "../calc_data.h"
#include "../libfft/r_fft_int16.h"		// FFTライブラリ

/************************************************************/
/* プロトタイプ宣言											*/
/************************************************************/
static	void	proc(double *data1, int len, int d);
static	void	debug_out	( char *f , double d[] , int size , int no );

//extern	void	debug_out	( char *f , double d[] , int size , int no );
extern	void	mado		( double in[] , double ot[] , int size , int mode );
extern	int		peak_modify	( double in_data[] , int in_res[] , double ot_data[] , double ot_hz[] , int size , double delta );	/* ☆ */
extern	void 	peak_vallay	( double in[] , int    ot[] , int size, int width , double th , int peak );
extern	void	cal_sp1		( double mx1 , double mx2 , int *sp );
extern	void	cal_sp2		( double mx1 , double mx2 , double *sp );
extern	void	ifft(double ar[] ,int N ,double ot[]);

/************************************************************/
/* 定数定義													*/
/************************************************************/
static const double test_data[DATA_SIZE_SPO2] = {
2.09044	,
2.07979	,
2.07527	,
2.07592	,
2.07947	,
2.09303	,
2.12596	,
2.16148	,
2.19894	,
2.24866	,
2.25125	,
2.21218	,
2.16697	,
2.12177	,
2.09012	,
2.07624	,
2.06009	,
2.03911	,
2.01101	,
1.98647	,
1.96613	,
1.94902	,
1.97033	,
2.00456	,
1.99164	,
1.95935	,
1.92932	,
1.91705	,
1.91996	,
1.92545	,
1.92771	,
1.92964	,
1.93126	,
1.93965	,
1.95128	,
2.01586	,
2.07721	,
2.08334	,
2.07107	,
2.05041	,
2.03685	,
2.03006	,
2.02102	,
2.00843	,
2.001	,
2.00068	,
1.99778	,
2.00811	,
2.06655	,
2.10078	,
2.09174	,
2.07075	,
2.04718	,
2.03911	,
2.03781	,
2.03232	,
2.02554	,
2.02135	,
2.0207	,
2.01844	,
2.04524	,
2.10401	,
2.11757	,
2.10175	,
2.07817	,
2.06913	,
2.0743	,
2.07656	,
2.07172	,
2.063	,
2.05428	,
2.05008	,
2.04847	,
2.08722	,
2.13597	,
2.12822	,
2.10336	,
2.07721	,
2.06752	,
2.06913	,
2.07172	,
2.06494	,
2.06009	,
2.05783	,
2.04976	,
2.04459	,
2.08754	,
2.15147	,
2.15276	,
2.13759	,
2.13016	,
2.14243	,
2.1786	,
2.20475	,
2.22057	,
2.2196	,
2.197	,
2.1773	,
2.15502	,
2.13791	,
2.16374	,
2.15083	,
2.09658	,
2.03588	,
1.99196	,
1.9629	,
1.93868	,
1.90414	,
1.87378	,
1.84827	,
1.83019	,
1.82341	,
1.82729	,
1.87443	,
1.89542	,
1.87798	,
1.86571	,
1.86668	,
1.88961	,
1.91673	,
1.93739	,
1.94353	,
1.94773	,
1.9516	,
1.95838	,
1.97808	,
2.05493	,
2.09561	,
2.08948	,
2.07139	,
2.04556	,
2.03265	,
2.0278	,
2.01844	,
2.00779	,
1.99713	,
1.9939	,
1.99551	,
2.01683	,
2.09044	,
2.11563	,
2.10046	,
2.07462	,
2.05622	,
2.05073	,
2.05396	,
2.05105	,
2.04007	,
2.03103	,
2.02199	,
2.01683	,
2.04621	,
2.11337	,
2.12467	,
2.10562	,
2.09271	,
2.0898	,
2.09852	,
2.11337	,
2.12435	,
2.12661	,
2.12564	,
2.13178	,
2.13597	,
2.15309	,
2.21992	,
2.22703	,
2.20281	,
2.19183	,
2.19797	,
2.22219	,
2.25641	,
2.27805	,
2.2774	,
2.24446	,
2.19313	,
2.12725	,
2.09044	,
2.10304	,
2.07979	,
1.99745	,
1.9474	,
1.93416	,
1.94256	,
1.95418	,
1.94224	,
1.92577	,
1.90704	,
1.89865	,
1.88444	,
1.86119	,
1.84795	,
1.88476	,
1.88153	,
1.8415	,
1.81082	,
1.80727	,
1.84182	,
1.88605	,
1.91156	,
1.92286	,
1.93675	,
1.94837	,
1.95677	,
1.99132	,
2.09206	,
2.13178	,
2.11176	,
2.07785	,
2.04847	,
2.03362	,
2.02651	,
2.01521	,
2.00391	,
1.99681	,
1.99455	,
1.99551	,
2.02361	,
2.09012	,
2.10756	,
2.08819	,
2.06139	,
2.03846	,
2.03652	,
2.03749	,
2.032	,
2.02877	,
2.02522	,
2.02587	,
2.02587	,
2.05363	,
2.13274	,
2.14857	,
2.12435	,
2.09432	,
2.07236	,
2.07204	,
2.07656	,
2.07236	,
2.06139	,
2.063	,
2.07947	,
2.09981	,
2.15309	,
2.2548	,
2.27449	,
2.26061	,
2.23478	,
2.22477	,
2.24673	,
2.28354	,
2.30678	,
2.30872	,
2.29419	,
2.28547	,
2.26771	,
};

// FFTに与える窓のデータ ハニング関数
static const int16_t window_data[DATA_SIZE_SPO2] = {
0	,
4	,
19	,
44	,
79	,
124	,
178	,
243	,
317	,
401	,
494	,
598	,
710	,
833	,
965	,
1106	,
1256	,
1416	,
1585	,
1762	,
1949	,
2144	,
2348	,
2561	,
2782	,
3011	,
3248	,
3493	,
3746	,
4007	,
4275	,
4551	,
4834	,
5124	,
5420	,
5723	,
6033	,
6349	,
6671	,
6999	,
7333	,
7672	,
8017	,
8366	,
8721	,
9080	,
9444	,
9811	,
10183	,
10559	,
10938	,
11320	,
11705	,
12094	,
12485	,
12878	,
13273	,
13670	,
14069	,
14470	,
14871	,
15273	,
15677	,
16080	,
16484	,
16887	,
17291	,
17693	,
18095	,
18496	,
18896	,
19294	,
19690	,
20085	,
20477	,
20866	,
21253	,
21637	,
22018	,
22395	,
22769	,
23139	,
23504	,
23866	,
24223	,
24575	,
24922	,
25264	,
25600	,
25931	,
26256	,
26575	,
26888	,
27195	,
27495	,
27788	,
28074	,
28354	,
28626	,
28890	,
29147	,
29396	,
29638	,
29871	,
30096	,
30313	,
30521	,
30721	,
30912	,
31094	,
31267	,
31431	,
31587	,
31732	,
31869	,
31996	,
32114	,
32222	,
32320	,
32409	,
32488	,
32558	,
32617	,
32667	,
32706	,
32736	,
32756	,
32766	,
32766	,
32756	,
32737	,
32707	,
32667	,
32617	,
32558	,
32489	,
32410	,
32321	,
32223	,
32115	,
31997	,
31870	,
31733	,
31588	,
31433	,
31269	,
31095	,
30913	,
30722	,
30523	,
30314	,
30098	,
29873	,
29640	,
29398	,
29149	,
28892	,
28628	,
28356	,
28077	,
27790	,
27497	,
27197	,
26891	,
26578	,
26259	,
25934	,
25603	,
25266	,
24924	,
24577	,
24225	,
23868	,
23507	,
23141	,
22772	,
22398	,
22021	,
21640	,
21256	,
20869	,
20480	,
20088	,
19693	,
19297	,
18899	,
18499	,
18098	,
17696	,
17294	,
16890	,
16487	,
16083	,
15680	,
15276	,
14874	,
14473	,
14072	,
13673	,
13276	,
12881	,
12487	,
12097	,
11708	,
11323	,
10941	,
10561	,
10186	,
9814	,
9446	,
9083	,
8724	,
8369	,
8019	,
7675	,
7336	,
7002	,
6674	,
6352	,
6036	,
5726	,
5422	,
5126	,
4836	,
4553	,
4277	,
4009	,
3748	,
3495	,
3250	,
3013	,
2783	,
2562	,
2350	,
2146	,
1950	,
1764	,
1586	,
1417	,
1257	,
1107	,
966	,
834	,
711	,
598	,
495	,
401	,
317	,
243	,
179	,
124	,
79	,
44	,
20	,
5	,
0	,
};

/************************************************************/
/* 変数定義													*/
/************************************************************/
double*	p4;
double*	f1;

double	mx1;
double	mx2;
/*------------------------------------------------------------------------------*/
double	snpk1;
double	snpk2;
int		sp1;
double	sp2;
/*------------------------------------------------------------------------------*/
int16_t		fftresult[DATA_SIZE_SPO2*2];

/********************************************************************/
/* 関数     : calculator_pulse_oximeter								*/
/* 関数名   : パルスオキシメーター演算								*/
/* 引数     : なし													*/
/* 戻り値   : なし													*/
/* 変更履歴 : 2018.01.11 Axia Soft Design 和田	初版作成			*/
/********************************************************************/
/* 機能 :															*/
/* 																	*/
/********************************************************************/
/* 注意事項 :														*/
/* なし																*/
/********************************************************************/
// データ数はFFTライブラリに合わせて256固定
void calculator_pulse_oximeter(const short* pdata1, const short* pdata2)
{
	double tmp;
	int i;
	
	for (i=0; i<DATA_SIZE_SPO2; i++)
	{
		tmp = (double)pdata1[i];
		// -3〜3Vの24bit分解能AD値
		temp_dbl_buf2[i] = (double)(tmp * 3 / 8388607);
	}
	proc(test_data, DATA_SIZE_SPO2, 1);
//	proc(temp_dbl_buf2, DATA_SIZE_SPO2, 1);
	snpk1 = f1[0];
	mx1 = p4[0];
	if((0 > snpk1) || (snpk1 > 200)){
		snpk1 = 0;
	}
	
	for (i = 0; i<DATA_SIZE_SPO2; i++)
	{
		tmp = (double)pdata2[i];
		temp_dbl_buf2[i] = (double)(tmp * 3 / 8388607);
	}
//	proc(temp_dbl_buf2, DATA_SIZE_SPO2, 2);
	snpk2 = f1[0];
	mx2 = p4[0];
	if((0 > snpk2) || (snpk2 > 200)){
		snpk2 = 0;
	}
	
	/*- SPO2 --------------------------------------------------------------*/
	cal_sp1( mx1 , mx2 , &sp1 );
	if((0 > sp1) || (sp1 > 200)){
		sp1 = 0;
	}
	cal_sp2( mx1 , mx2 , &sp2 );
	if((0 > sp2) || (sp2 > 200)){
		sp2 = 0;
	}
}

/********************************************************************/
/* 関数     : proc													*/
/* 関数名   : 														*/
/* 引数     : なし													*/
/* 戻り値   : なし													*/
/* 変更履歴 : 2018.01.11 Axia Soft Design 和田	初版作成			*/
/********************************************************************/
/* 機能 :															*/
/* 																	*/
/********************************************************************/
/* 注意事項 :														*/
/* len = 128でないと動かない										*/
/********************************************************************/
static void	proc(double *data1, int len, int d)
{
	int ii;
	double dc;
	
	double* ph11;
	int16_t* pfft_in;

	int* pfft_out;

	double* a1;
	double* p2;
	double* ar2;
	double* ai2;
	double* p3;
	int* peak1;
	
	const int start = 8;
	const int end   = 92 + start;
	
	int size;
	double max;
	int peaksize1;
	
	/*- DC推定 -----------------------------------------------------------------*/
	dc = 0.0f;
	for(ii=0;ii<len;++ii){
		dc += data1[ii];
	}
	dc /= len;
	
	/*- hosei1 -----------------------------------------------------------------*/
	ph11 = &temp_dbl_buf0[0];
	for(ii=0;ii<len;++ii){
		ph11[ii] = data1[ii] - dc;
	}
	// h11
	pfft_in = &temp_int_buf0[0];
	for(ii=0;ii<len;++ii){
		pfft_in[ii] = (int16_t)(ph11[ii] * 32768.0f);
	}
	
	/*- fft --------------------------------------------------------------------*/
	pfft_out = &fftresult[0];
    /* execute 256-point real FFT with windowing */
    R_rfft256_int16(pfft_in, pfft_out, window_data, temp_int_buf1);

	/*- 不要なデータをマスクする------------------------------------------------*/
	/*- パワーを求める----------------------------------------------------------*/
	a1 = &temp_dbl_buf1[0];
	p2 = &temp_dbl_buf0[0];
	for(ii=0;ii<len;++ii){
		a1[ii] = pfft_out[ii] / 256.0;
	}
	// startまではall 0
	for(ii=0;ii<start;++ii){
		p2[ii] = 0;
	}
	for(ii=start;ii<end;++ii){
		p2[ii] = a1[2*ii]*a1[2*ii] + a1[2*ii+1]*a1[2*ii+1];
		p2[ii] = sqrt(p2[ii]);
	}
	for(ii=end;ii<len;++ii){
		p2[ii] = 0;
	}
	
	/*- 2乗根 --------------------------------------------------------------*/
	for(ii=0;ii<len;++ii){
		p2[ii] = sqrt(p2[ii]);
	}
	
	/*- 逆FFT --------------------------------------------------------------*/
	ar2 = &temp_dbl_buf1[0];
	ai2 = &temp_dbl_buf2[0];
	size = len/2;
	for(ii=0;ii<size;++ii){
		ar2[ii] = p2[ii];
		ai2[ii] = 0;
	}
	for(ii=0;ii<size;++ii){
		ar2[size+ii] = p2[size-ii];
		ai2[size+ii] = 0;
	}
	
	p3 = &temp_dbl_buf0[0];
	ifft(ar2, len, p3);
	
	/*- 最大値との比を計算 --------------------------------------------------------------*/
	max = 0;
	for(ii=0;ii<len;++ii){
		if(max < p3[ii]){
			max = p3[ii];
		}
	}
	for(ii=0;ii<len;++ii){
		p3[ii] /= max;
	}
	
	/*- ピーク検出 --------------------------------------------------------------*/
	peak1 = &temp_int_buf0[0];
	p4 = &temp_dbl_buf1[0];
	f1 = &temp_dbl_buf2[0];
	peak_vallay( p3 , peak1 , len, 3 , 0.05 , 1 );
	peaksize1 = peak_modify( p3 , peak1 , p4 , f1 , len , 1);
	
	/*- HR --------------------------------------------------------------*/
	for(ii=0;ii<peaksize1;++ii){
		f1[ii] = 60 / (f1[ii] / 6);
	}
}

/*==============================================================================*/
/* EOF */
